<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalStorage Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 5px; padding: 10px; }
        .output { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Halome 文件存储调试</h1>
    
    <div>
        <button onclick="testSave()">测试保存文件</button>
        <button onclick="testGet()">查看存储的文件</button>
        <button onclick="clearStorage()">清空存储</button>
    </div>
    
    <div id="output" class="output">
        点击按钮开始测试...
    </div>

    <script>
        const STORAGE_KEY = 'halome_uploaded_files';

        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += '<pre>' + JSON.stringify(message, null, 2) + '</pre>';
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        function testSave() {
            clearOutput();
            log('开始测试保存...');
            
            // 模拟文件信息
            const testFile = {
                fileId: 'test_' + Date.now(),
                fileName: 'test-file.txt',
                fileSize: 1024,
                type: 'text/plain',
                uploadMethod: 'small'
            };
            
            log('准备保存的文件信息:');
            log(testFile);
            
            // 获取现有文件
            const existingFiles = getUploadedFiles();
            log('现有文件数量: ' + existingFiles.length);
            
            // 保存文件
            saveUploadedFile(testFile);
            
            // 验证保存结果
            const updatedFiles = getUploadedFiles();
            log('保存后文件数量: ' + updatedFiles.length);
            log('最新的文件:');
            log(updatedFiles[0]);
        }

        function testGet() {
            clearOutput();
            log('查看localStorage内容...');
            
            const raw = localStorage.getItem(STORAGE_KEY);
            log('原始数据: ' + raw);
            
            const files = getUploadedFiles();
            log('解析后的文件列表:');
            log(files);
        }

        function clearStorage() {
            localStorage.removeItem(STORAGE_KEY);
            clearOutput();
            log('存储已清空');
        }

        // 复制localStorage函数
        function getUploadedFiles() {
            try {
                const storedFiles = localStorage.getItem(STORAGE_KEY);
                return storedFiles ? JSON.parse(storedFiles) : [];
            } catch (error) {
                console.error('Failed to get uploaded files from localStorage:', error);
                return [];
            }
        }

        function saveUploadedFile(fileInfo) {
            try {
                const files = getUploadedFiles();
                const newFile = {
                    id: fileInfo.fileId || fileInfo.id,
                    name: fileInfo.fileName || fileInfo.name,
                    size: fileInfo.fileSize || fileInfo.size,
                    uploadTime: Date.now(),
                    type: fileInfo.type || 'unknown',
                    uploadMethod: fileInfo.uploadMethod || 'unknown',
                    ...fileInfo
                };
                
                const existingIndex = files.findIndex(f => f.id === newFile.id);
                if (existingIndex !== -1) {
                    files[existingIndex] = newFile;
                } else {
                    files.unshift(newFile);
                }
                
                const limitedFiles = files.slice(0, 100);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(limitedFiles));
                
                log('文件已保存到localStorage');
                return true;
            } catch (error) {
                log('保存失败: ' + error.message);
                return false;
            }
        }
    </script>
</body>
</html> 